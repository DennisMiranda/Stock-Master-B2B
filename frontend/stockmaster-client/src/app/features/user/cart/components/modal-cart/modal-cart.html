<div
  class="fixed inset-0 z-50 bg-white shadow-2xl w-full max-w-xs overflow-hidden flex flex-col"
  (click)="$event.stopPropagation()"
>
  <!-- Header -->
  <div class="border-b border-gray-100 border flex justify-between items-center w-full px-6 py-1">
    <h2 class="text-lg font-bold text-gray-900">Añadir al carrito</h2>
    <button
      (click)="closeModal.emit()"
      class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
      aria-label="Cerrar"
    >
      <lucide-icon [img]="XIcon" class="w-5 h-5 text-gray-500" />
    </button>
  </div>

  <!-- Content - Scrollable -->
  <div class="flex-1 overflow-y-auto px-6 py-3 space-y-4">
    <!-- Product Info -->
    <div class="flex gap-3">
      <div
        class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden"
      >
        @if (product().images && product().images!.length > 0) {
        <img
          [src]="product().images![0]"
          [alt]="product().name"
          class="w-full h-full object-cover"
        />
        } @else {
        <lucide-icon [img]="PackageIcon" class="w-8 h-8 text-gray-400" />
        }
      </div>
      <div class="flex-1 min-w-0">
        <h3 class="font-semibold text-gray-900 text-sm mb-1 line-clamp-2">{{ product().name }}</h3>
        <p class="text-xs text-gray-500">SKU: {{ product().sku }}</p>
      </div>
    </div>

    <!-- Variants with Quantities -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-3"> Selecciona cantidad </label>
      <ul class="space-y-3">
        @for (price of product().prices; track price.label) {
        <li
          class="border-2 grid grid-cols-2 justify-between border-gray-200 rounded-sm px-4 py-3 hover:border-gray-300 transition-colors"
        >
          <div class="flex flex-col justify-between space-y-2">
            <div class="flex gap-4 items-center">
              <lucide-icon
                [img]="price.label === 'unit' ? PackageIcon : TagIcon"
                class="w-4 h-4 text-gray-600"
              />

              <div>
                <p class="text-sm font-semibold text-gray-900">
                  {{ price.label === 'unit' ? 'Unitario' : 'Por Caja' }}
                </p>
              </div>
            </div>
            <div class=" ">
              <p class="text-sm font-bold text-gray-900">
                {{ getEffectivePrice(price.label) | currency : 'PEN' : 'symbol' : '1.2-2' }}
              </p>
              @if (getAppliedDiscount(price.label)) {
              <p class="text-xs text-gray-400 line-through">
                {{ price.price | currency : 'PEN' : 'symbol' : '1.2-2' }}
              </p>
              } @if (price.label === 'box' && product().unitPerBox) {
              <p class="text-xs text-gray-500">{{ product().unitPerBox }} unidades</p>
              }
            </div>
          </div>
          <div class="flex flex-col items-start space-y-2">
            <div class="flex items-center w-full gap-2">
              <button
                (click)="decreaseQuantity(price.label)"
                [disabled]="getQuantity(price.label) <= 0"
                class="w-5 h-5 rounded-sm border border-gray-300 hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center transition-all"
              >
                <lucide-icon [img]="MinusIcon" class="w-4 h-4 text-gray-600" />
              </button>

              <input
                type="number"
                [value]="getQuantity(price.label)"
                (input)="onQuantityInput($event, price.label)"
                min="0"
                [max]="getMaxQuantity(price.label)"
                class="flex-1 text-center text-xs font-semibold text-gray-900 border border-gray-300 rounded-sm py-0.5 px-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="0"
              />

              <button
                (click)="increaseQuantity(price.label)"
                [disabled]="getQuantity(price.label) >= getMaxQuantity(price.label)"
                class="w-5 h-5 rounded-sm border border-gray-300 hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center transition-all"
              >
                <lucide-icon [img]="PlusIcon" class="w-4 h-4 text-gray-600" />
              </button>
            </div>
            <div class="flex flex-col justify-between text-xs">
              <span class="text-gray-500">
                Stock: <span class="font-semibold">{{ getMaxQuantity(price.label) }}</span>
              </span>
              @if (getAppliedDiscount(price.label)) {
              <span class="text-green-600 font-semibold"> Descuento aplicado </span>
              }
            </div>
          </div>

          <div class="mt-3 col-span-2 pt-3 border-t border-gray-200 flex justify-between text-sm">
            <span class="text-gray-600 font-medium">Subtotal:</span>
            <span class="font-bold text-gray-900">
              {{ getVariantTotal(price.label) | currency : 'PEN' : 'symbol' : '1.2-2' }}
            </span>
          </div>
        </li>
        @if (price.discounts && price.discounts.length > 0) {
        <div class="mt-3 bg-amber-50 border border-amber-200 rounded-lg p-2">
          <p class="text-xs font-semibold text-amber-900 mb-1">Descuentos:</p>
          <div class="space-y-0.5">
            @for (discount of price.discounts; track discount.minQuantity) {
            <p class="text-xs text-amber-700">
              • {{ discount.minQuantity }}+ unidades:
              <span class="font-semibold">{{
                discount.price | currency : 'PEN' : 'symbol' : '1.2-2'
              }}</span>
            </p>
            }
          </div>
        </div>
        } }
      </ul>
    </div>

    <!-- Total Summary -->
  </div>

  <!-- Footer -->
  
    <div class="flex  border-gray-200 border-t justify-between px-4 pt-4 ">
      <div class="space-y-2">
        <p class="text-xs text-gray-900 ">Total a pagar</p>
        <p class="text-xl font-bold text-gray-900">
          {{ grandTotal() | currency : 'PEN' : 'symbol' : '1.2-2' }}
        </p>
      </div>
      <div class="text-right  space-y-2">
        <p class="text-xs text-gray-600">
          {{ totalItems() }} item{{ totalItems() !== 1 ? 's' : '' }}
        </p>
        @if (totalSavings() > 0) {
        <p class="text-sm text-green-600 font-semibold">
          Ahorras {{ totalSavings() | currency : 'PEN' : 'symbol' : '1.2-2' }}
        </p>
        }
      </div>
    </div>


  <div class="flex gap-3 p-4">
    <button
      (click)="closeModal.emit()"
      class="flex-1 px-4 active:scale-95  text-xs py-3 border-2 border-gray-300 text-gray-600 rounded-sm font-semibold hover:bg-white transition-all"
    >
      Cancelar
    </button>
<button
  (click)="addToCart()"
  [disabled]="grandTotal() === 0"
  class="flex-1 text-xs px-4 py-3 
         bg-gray-700 
         hover:bg-azul active:bg-azul active:scale-95
         disabled:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100
         text-white rounded-sm font-semibold transition-all 
         flex items-center justify-center gap-2"
>
  <lucide-icon [img]="ShoppingCartIcon" class="w-4 h-4" />
  <span class="text-xs">Agregar</span>
</button>

  </div>
</div>
